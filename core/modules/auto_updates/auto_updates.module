<?php

/**
 * @file
 * Contains hook implementations for Automatic Updates.
 */

use Drupal\auto_updates\ReadinessChecker\ReadinessCheckerMessages;

/**
 * Implements hook_page_top().
 */
function auto_updates_page_top(array &$page_top) {
  /** @var \Drupal\auto_updates\ReadinessChecker\ReadinessCheckerMessages $readiness_messages */
  $readiness_messages = \Drupal::classResolver(ReadinessCheckerMessages::class);
  $readiness_messages->adminPageMessages();
}

/**
 * Implements hook_cron().
 */
function auto_updates_cron() {
  /** @var \Drupal\auto_updates\ReadinessChecker\ReadinessCheckerManager $checker_manager */
  $checker_manager = \Drupal::service('auto_updates.readiness_checker_manager');
  $last_results = $checker_manager->getResults();
  $last_run_time = $checker_manager->getMostRecentRunTime();
  // Do not run readiness checks more than once an hour unless there are no
  // results available.
  if (is_null($last_results) || !$last_run_time || \Drupal::time()->getRequestTime() - $last_run_time > 3600) {
    $checker_manager->run();
  }

}

/**
 * Implements hook_modules_installed().
 */
function auto_updates_modules_installed() {
  // Run the readiness checkers when any modules are installed in case they
  // provide readiness checker services.
  /** @var \Drupal\auto_updates\ReadinessChecker\ReadinessCheckerManager $checker_manager */
  $checker_manager = \Drupal::service('auto_updates.readiness_checker_manager');
  $results = $checker_manager->getResults();
  // Only run the checkers if $result is NULL because this indicates the
  // previous results are not valid.
  if (is_null($results)) {
    $checker_manager->run();
  }
}

/**
 * Implements hook_modules_uninstalled().
 */
function auto_updates_modules_uninstalled($modules, $is_syncing) {
  // Run the readiness checkers when any are uninstalled modules are installed
  // in case they provided readiness checker services.
  /** @var \Drupal\auto_updates\ReadinessChecker\ReadinessCheckerManager $checker_manager */
  $checker_manager = \Drupal::service('auto_updates.readiness_checker_manager');
  $results = $checker_manager->getResults();
  // Only run the checkers if $result is NULL because this indicates the
  // previous results are not valid.
  if (is_null($results)) {
    $checker_manager->run();
  }
}
